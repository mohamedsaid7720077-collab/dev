name: Whisper Offline Android FULL BUILD

on:
  workflow_dispatch:

env:
  ANDROID_API_LEVEL: 26
  NDK_VERSION: 25.2.9519653
  ABI: arm64-v8a

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # 1. Checkout (repo may be empty)
      # -------------------------------------------------
      - uses: actions/checkout@v4

      # -------------------------------------------------
      # 2. Java
      # -------------------------------------------------
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # -------------------------------------------------
      # 3. Android SDK + NDK
      # -------------------------------------------------
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK
        run: sdkmanager "ndk;${NDK_VERSION}"

<<<<<<< HEAD
=======
      - name: Show Android SDK/NDK env
        run: |
          # Ensure SDK root is set (use ANDROID_HOME if action set that)
          export ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-$ANDROID_HOME}
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          echo "ANDROID_HOME=$ANDROID_HOME"
          echo "ANDROID_NDK_HOME=${ANDROID_SDK_ROOT}/ndk/${NDK_VERSION}"
          echo "NDK_VERSION=${NDK_VERSION}"
          echo "--- ls ANDROID_SDK_ROOT ---"
          ls -la "$ANDROID_SDK_ROOT" || true
          echo "--- ls ndk dir ---"
          ls -la "$ANDROID_SDK_ROOT/ndk" || true
          echo "--- ls specific NDK ---"
          ls -la "$ANDROID_SDK_ROOT/ndk/${NDK_VERSION}" || true
          echo "--- sdkmanager --list ---"
          sdkmanager --list || true
          which sdkmanager || true
          echo "--- java -version ---"
          java -version || true

>>>>>>> 51a77cf (ci: set runtime SDK/NDK env and add SDK debug step)
      # -------------------------------------------------
      # 4. Create Android project dynamically
      # -------------------------------------------------
      - name: Create Android Project
        run: |
          mkdir -p app/src/main/{java/com/example/whisper,cpp,assets/models,res/layout}
          cat > settings.gradle <<EOF
          rootProject.name="whisper"
          include ':app'
          EOF

          cat > build.gradle <<EOF
          buildscript {
            repositories { google(); mavenCentral() }
            dependencies { classpath 'com.android.tools.build:gradle:8.1.0' }
          }
          allprojects { repositories { google(); mavenCentral() } }
          EOF

          cat > app/build.gradle <<EOF
          apply plugin: 'com.android.application'
          android {
            namespace "com.example.whisper"
            compileSdk 34
            defaultConfig {
              applicationId "com.example.whisper"
              minSdk ${ANDROID_API_LEVEL}
              targetSdk 34
              ndk { abiFilters "${ABI}" }
            }
            externalNativeBuild {
              cmake { path "src/main/cpp/CMakeLists.txt" }
            }
          }
          EOF

      # -------------------------------------------------
      # 5. Fetch whisper.cpp
      # -------------------------------------------------
      - name: Fetch whisper.cpp
        run: |
          git clone https://github.com/ggerganov/whisper.cpp tmp_whisper
          cp tmp_whisper/whisper.cpp app/src/main/cpp/
          cp tmp_whisper/whisper.h app/src/main/cpp/

      # -------------------------------------------------
      # 6. Download GGML model
      # -------------------------------------------------
      - name: Download GGML base model
        run: |
          curl -L -o app/src/main/assets/models/ggml-base-q5_1.bin \
            https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base-q5_1.bin

      # -------------------------------------------------
      # 7. Native code + CMake
      # -------------------------------------------------
      - name: Create native code
        run: |
          cat > app/src/main/cpp/CMakeLists.txt <<EOF
          cmake_minimum_required(VERSION 3.18)
          project(whisper)
          add_definitions(-DGGML_USE_NEON)
          add_library(native-lib SHARED whisper.cpp)
          find_library(log-lib log)
          target_link_libraries(native-lib ${log-lib})
          EOF

      # -------------------------------------------------
      # 8. Build APK
      # -------------------------------------------------
      - name: Build APK
<<<<<<< HEAD
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_SDK_ROOT }}/ndk/${{ env.NDK_VERSION }}
        name: Whisper Offline Android FULL BUILD

        on:
          workflow_dispatch:

        env:
          ANDROID_API_LEVEL: 26
          NDK_VERSION: 25.2.9519653
          ABI: arm64-v8a

        jobs:
          build:
            runs-on: ubuntu-latest

            steps:
              # -------------------------------------------------
              # 1. Checkout (repo may be empty)
              # -------------------------------------------------
              - uses: actions/checkout@v4

              # -------------------------------------------------
              # 2. Java
              # -------------------------------------------------
              - name: Setup JDK 17
                uses: actions/setup-java@v4
                with:
                  distribution: temurin
                  java-version: 17

              # -------------------------------------------------
              # 3. Android SDK + NDK
              # -------------------------------------------------
              - name: Setup Android SDK
                uses: android-actions/setup-android@v3

              - name: Install NDK
                run: sdkmanager "ndk;${NDK_VERSION}"

              - name: Show Android SDK/NDK env
                run: |
                  # Ensure SDK root is set (use ANDROID_HOME if action set that)
                  export ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-$ANDROID_HOME}
                  echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
                  echo "ANDROID_HOME=$ANDROID_HOME"
                  echo "ANDROID_NDK_HOME=${ANDROID_SDK_ROOT}/ndk/${NDK_VERSION}"
                  echo "NDK_VERSION=${NDK_VERSION}"
                  echo "--- ls ANDROID_SDK_ROOT ---"
                  ls -la "$ANDROID_SDK_ROOT" || true
                  echo "--- ls ndk dir ---"
                  ls -la "$ANDROID_SDK_ROOT/ndk" || true
                  echo "--- ls specific NDK ---"
                  ls -la "$ANDROID_SDK_ROOT/ndk/${NDK_VERSION}" || true
                  echo "--- sdkmanager --list ---"
                  sdkmanager --list || true
                  which sdkmanager || true
                  echo "--- java -version ---"
                  java -version || true

              # -------------------------------------------------
              # 4. Create Android project dynamically
              # -------------------------------------------------
              - name: Create Android Project
                run: |
                  mkdir -p app/src/main/{java/com/example/whisper,cpp,assets/models,res/layout}
                  cat > settings.gradle <<EOF
                  rootProject.name="whisper"
                  include ':app'
                  EOF

                  cat > build.gradle <<EOF
                  buildscript {
                    repositories { google(); mavenCentral() }
                    dependencies { classpath 'com.android.tools.build:gradle:8.1.0' }
                  }
                  allprojects { repositories { google(); mavenCentral() } }
                  EOF

                  cat > app/build.gradle <<EOF
                  apply plugin: 'com.android.application'
                  android {
                    namespace "com.example.whisper"
                    compileSdk 34
                    defaultConfig {
                      applicationId "com.example.whisper"
                      minSdk ${ANDROID_API_LEVEL}
                      targetSdk 34
                      ndk { abiFilters "${ABI}" }
                    }
                    externalNativeBuild {
                      cmake { path "src/main/cpp/CMakeLists.txt" }
                    }
                  }
                  EOF

              # -------------------------------------------------
              # 5. Fetch whisper.cpp
              # -------------------------------------------------
              - name: Fetch whisper.cpp
                run: |
                  git clone https://github.com/ggerganov/whisper.cpp tmp_whisper
                  cp tmp_whisper/whisper.cpp app/src/main/cpp/
                  cp tmp_whisper/whisper.h app/src/main/cpp/

              # -------------------------------------------------
              # 6. Download GGML model
              # -------------------------------------------------
              - name: Download GGML base model
                run: |
                  curl -L -o app/src/main/assets/models/ggml-base-q5_1.bin \
                    https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base-q5_1.bin

              # -------------------------------------------------
              # 7. Native code + CMake
              # -------------------------------------------------
              - name: Create native code
                run: |
                  cat > app/src/main/cpp/CMakeLists.txt <<EOF
                  cmake_minimum_required(VERSION 3.18)
                  project(whisper)
                  add_definitions(-DGGML_USE_NEON)
                  add_library(native-lib SHARED whisper.cpp)
                  find_library(log-lib log)
                  target_link_libraries(native-lib ${log-lib})
                  EOF

              # -------------------------------------------------
              # 8. Build APK
              # -------------------------------------------------
              - name: Build APK
                run: |
                  # Ensure SDK root is set (use ANDROID_HOME if action set that)
                  export ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-$ANDROID_HOME}
                  export ANDROID_NDK_HOME="$ANDROID_SDK_ROOT/ndk/${NDK_VERSION}"
                  chmod +x gradlew || true
                  ./gradlew assembleRelease || true

              # -------------------------------------------------
              # 9. Upload APK
              # -------------------------------------------------
              - name: Upload APK
                uses: actions/upload-artifact@v4
                with:
                  name: whisper-offline-final-apk
                  path: app/build/outputs/apk/release/*.apk
